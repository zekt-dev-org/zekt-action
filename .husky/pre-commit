#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit security checks..."

# Check for potential GitHub token leaks in SOURCE CODE ONLY
# (dist/ contains bundled webpack code with test strings, so exclude it)
# Patterns to detect:
# - GITHUB_TOKEN in logs or assignments
# - GitHub token prefixes (ghp_, gho_, ghs_, ghu_)
# - console.log or core.info with token variables

FORBIDDEN_PATTERNS=(
  "console\.log.*token"
  "console\.log.*GITHUB_TOKEN"
  "core\.info.*token"
  "core\.info.*GITHUB_TOKEN"
  "core\.debug.*token"
  "core\.warning.*token"
  "core\.error.*token"
  "ghp_[a-zA-Z0-9]{36}"
  "gho_[a-zA-Z0-9]{36}"
  "ghs_[a-zA-Z0-9]{36}"
  "ghu_[a-zA-Z0-9]{36}"
)

VIOLATIONS_FOUND=false

# Only check src/ and action.yml - exclude dist/ (bundled webpack), tests/, and node_modules/
# This allows safe test token strings while preventing production code token leaks
for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
  if git diff --cached --diff-filter=d -- 'src/*' 'action.yml' 'package.json' | grep -iE "$pattern"; then
    echo "‚ùå ERROR: Potential token leak detected in source code with pattern: $pattern"
    VIOLATIONS_FOUND=true
  fi
done

if [ "$VIOLATIONS_FOUND" = true ]; then
  echo ""
  echo "‚ö†Ô∏è  COMMIT BLOCKED: Potential GitHub token leak detected in production code!"
  echo "Please review the changes above and remove any token logging from src/ files."
  echo ""
  echo "Security rules:"
  echo "  - Never log github_token or GITHUB_TOKEN in source code"
  echo "  - Never log variables containing 'token' in production code"
  echo "  - Never commit actual token values (ghp_, gho_, etc.) in source files"
  echo ""
  echo "Test files and bundled code are excluded from this check."
  echo ""
  exit 1
fi

echo "‚úÖ Security checks passed"
exit 0

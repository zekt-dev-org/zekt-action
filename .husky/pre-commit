#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit security checks..."

# Check for potential GitHub token leaks
# Patterns to detect:
# - GITHUB_TOKEN in logs or assignments
# - GitHub token prefixes (ghp_, gho_, ghs_, ghu_)
# - console.log or core.info with token variables

FORBIDDEN_PATTERNS=(
  "console\.log.*token"
  "console\.log.*GITHUB_TOKEN"
  "core\.info.*token"
  "core\.info.*GITHUB_TOKEN"
  "core\.debug.*token"
  "core\.warning.*token"
  "core\.error.*token"
  "ghp_[a-zA-Z0-9]{36}"
  "gho_[a-zA-Z0-9]{36}"
  "ghs_[a-zA-Z0-9]{36}"
  "ghu_[a-zA-Z0-9]{36}"
)

VIOLATIONS_FOUND=false

for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
  if git diff --cached --diff-filter=d | grep -iE "$pattern"; then
    echo "‚ùå ERROR: Potential token leak detected with pattern: $pattern"
    VIOLATIONS_FOUND=true
  fi
done

if [ "$VIOLATIONS_FOUND" = true ]; then
  echo ""
  echo "‚ö†Ô∏è  COMMIT BLOCKED: Potential GitHub token leak detected!"
  echo "Please review the changes above and remove any token logging."
  echo ""
  echo "Security rules:"
  echo "  - Never log github_token or GITHUB_TOKEN"
  echo "  - Never log variables containing 'token'"
  echo "  - Never commit actual token values (ghp_, gho_, etc.)"
  echo ""
  exit 1
fi

echo "‚úÖ Security checks passed"
exit 0

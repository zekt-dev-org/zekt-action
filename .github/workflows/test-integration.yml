name: Integration Test

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test-action:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for OIDC authentication
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify jq is available
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Error: jq is not installed"
            exit 1
          fi
          echo "✅ jq is available: $(jq --version)"
      
      - name: Test action with valid payload
        id: test_valid
        uses: ./
        with:
          event-type: 'integration-test'
          payload: |
            {
              "test_type": "integration",
              "repository": "${{ github.repository }}",
              "workflow": "Integration Test",
              "run_number": ${{ github.run_number }}
            }
      
      - name: Verify success output
        run: |
          if [ "${{ steps.test_valid.outputs.status }}" != "success" ]; then
            echo "Error: Action did not succeed"
            echo "Status: ${{ steps.test_valid.outputs.status }}"
            exit 1
          fi
          echo "✅ Action succeeded"
          echo "Event ID: ${{ steps.test_valid.outputs.event-id }}"
          echo "Consumers Notified: ${{ steps.test_valid.outputs.consumers-notified }}"
      
      - name: Test with minimal payload
        id: test_minimal
        uses: ./
        with:
          event-type: 'minimal-test'
      
      - name: Test with complex payload
        id: test_complex
        uses: ./
        with:
          event-type: 'complex-test'
          payload: |
            {
              "deployment": {
                "version": "2.0.0",
                "environment": "staging",
                "features": ["feature-a", "feature-b"]
              },
              "metadata": {
                "triggered_by": "${{ github.actor }}",
                "commit": "${{ github.sha }}"
              }
            }
      
      - name: Test with invalid JSON (should fail)
        id: test_invalid
        uses: ./
        with:
          event-type: 'invalid-json-test'
          payload: '{invalid json}'
        continue-on-error: true
      
      - name: Verify invalid JSON test failed as expected
        run: |
          if [ "${{ steps.test_invalid.outputs.status }}" == "success" ]; then
            echo "Error: Invalid JSON test should have failed"
            exit 1
          fi
          echo "✅ Invalid JSON test failed as expected"
